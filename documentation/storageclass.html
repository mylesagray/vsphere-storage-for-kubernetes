<!DOCTYPE html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="keywords" content=" ">
<title>Dynamic Provisioning and StorageClass API | vSphere Storage for Kubernetes</title>
<link rel="stylesheet" href="css/syntax.css">


<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
<!--<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">-->
<link rel="stylesheet" href="css/modern-business.css">
<link rel="stylesheet" href="css/infracloudio-lavish-bootstrap.css">
<link rel="stylesheet" href="css/vmware-customstyles.css">
<link rel="stylesheet" href="css/infracloudio-theme-blue.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="js/jquery.navgoco.min.js"></script>


<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/2.0.0/anchor.min.js"></script>
<script src="js/toc.js"></script>
<script src="js/customscripts.js"></script>

<link rel="shortcut icon" href="images/favicon.ico">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link rel="alternate" type="application/rss+xml" title="" href="http://0.0.0.0:4000feed.xml">

    <script>
        $(document).ready(function() {
            // Initialize navgoco with default options
            $("#mysidebar").navgoco({
                caretHtml: '',
                accordion: true,
                openClass: 'active', // open
                save: false, // leave false or nav highlighting doesn't work right
                cookie: {
                    name: 'navgoco',
                    expires: false,
                    path: '/'
                },
                slide: {
                    duration: 400,
                    easing: 'swing'
                }
            });

            $("#collapseAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', false);
            });

            $("#expandAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', true);
            });

        });

    </script>
    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })
    </script>
    

</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container topnavlinks">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="fa fa-home fa-lg navbar-brand" href="index.html">&nbsp;<span class="projectTitle"> vSphere Storage for Kubernetes</span></a>
        </div>
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <!-- entries without drop-downs appear here -->
                
                
                
                <li><a href="index.html">Home</a></li>
                
                
                
                <li><a href="faqs.html">FAQs</a></li>
                
                
                
                <li><a href="contactus.html">Contact Us</a></li>
                
                
                
                <!-- entries with drop-downs appear here -->
                <!-- conditional logic to control which topnav appears for the audience defined in the configuration file.-->
                
                
                <!--comment out this block if you want to hide search-->
                <li>
                    <!--start search-->
                    <div id="search-demo-container">
                        <input type="text" id="search-input" placeholder="search...">
                        <ul id="results-container"></ul>
                    </div>
                    <script src="js/jekyll-search.js" type="text/javascript"></script>
                    <script type="text/javascript">
                            SimpleJekyllSearch.init({
                                searchInput: document.getElementById('search-input'),
                                resultsContainer: document.getElementById('results-container'),
                                dataSource: 'search.json',
                                searchResultTemplate: '<li><a href="{url}" title="Dynamic Provisioning and StorageClass API">{title}</a></li>',
                    noResultsText: 'No results found.',
                            limit: 10,
                            fuzzy: true,
                    })
                    </script>
                    <!--end search-->
                </li>
            </ul>
        </div>
        </div>
        <!-- /.container -->
</nav>

<!-- Page Content -->
<div class="container">
    <div class="col-lg-12">&nbsp;</div>
    <!-- Content Row -->
    <div class="row">
        <!-- Sidebar Column -->
        <div class="col-md-3">

          












<ul id="mysidebar" class="nav">
    <li class="sidebarTitle">Navigation </li>
    
    
    
    <li>
        <a href="#">vSphere Cloud Provider</a>
        <ul>
            
            
            
            <li><a href="index.html">Introduction</a></li>
            
            
            
            
            
            
            <li><a href="overview.html">Overview</a></li>
            
            
            
            <li class="subfolders">
                <a href="#">Provisioning Methods</a>
                <ul>
                    
                    
                    
                    <li><a href="policy-based-mgmt.html">Dynamic Provisioning (Recommended)</a></li>
                    
                    
                    
                    
                    
                    <li><a href="persistent-vols-claims.html">Static Provisioning</a></li>
                    
                    
                    
                </ul>
            </li>
            
            
            
            
            
            
            <li><a href="zones.html">Zone Support</a></li>
            
            
            
            
            
            
            <li><a href="versions.html">Versions</a></li>
            
            
            
            
        </ul>
        
        
    
    <li>
        <a href="#">Deployment</a>
        <ul>
            
            
            
            <li><a href="prerequisites.html">Prerequisites</a></li>
            
            
            
            
            
            
            <li><a href="existing.html">Configuration</a></li>
            
            
            
            
            
            
            <li><a href="vcp-roles.html">Permissions</a></li>
            
            
            
            
        </ul>
        
        
    
    <li>
        <a href="#">Upgrades</a>
        <ul>
            
            
            
            <li><a href="kubernetes-upgrade.html">Upgrade to v1.9.x</a></li>
            
            
            
            
        </ul>
        
        
    
    <li>
        <a href="#">Troubleshooting</a>
        <ul>
            
            
            
            <li><a href="faqs.html">FAQs</a></li>
            
            
            
            
            
            
            <li><a href="known-issues.html">Known Issues</a></li>
            
            
            
            
            
            
            <li><a href="troubleshooting.html">Logs and debugging</a></li>
            
            
            
            
        </ul>
        
        
    
    <li>
        <a href="#">Appendices</a>
        <ul>
            
            
            
            <li><a href="maximum-scale-limit.html">Scaling Limits</a></li>
            
            
            
            
            
            
            <li><a href="saml-token-authentication.html">SAML Authentication</a></li>
            
            
            
            
            
            
            <li><a href="k8s-secret.html">Securing Credentials</a></li>
            
            
            
            
            
            
            <li><a href="high-availability.html">High Availability of Kubernetes Cluster</a></li>
            
            
            
            <li class="subfolders">
                <a href="#">Example Applications</a>
                <ul>
                    
                    
                    
                    <li><a href="guestbook.html">Guestbook</a></li>
                    
                    
                    
                    
                    
                    <li><a href="minio.html">Minio</a></li>
                    
                    
                    
                    
                    
                    <li><a href="mongodb.html">MongoDB</a></li>
                    
                    
                    
                </ul>
            </li>
            
            
            
            
        </ul>
        
        
        
        <!-- if you aren't using the accordion, uncomment this block:
           <p class="external">
               <a href="#" id="collapseAll">Collapse All</a> | <a href="#" id="expandAll">Expand All</a>
           </p>
           -->
    </li>
</ul>
</div>

<!-- this highlights the active parent class in the navgoco sidebar. this is critical so that the parent expands when you're viewing a page. This must appear below the sidebar code above. Otherwise, if placed inside customscripts.js, the script runs before the sidebar code runs and the class never gets inserted.-->
<script>$("li.active").parents('li').toggleClass("active");</script>

    <!-- Content Column -->
    <div class="col-md-9">
        <div class="post-header">
   <h1 class="post-title-main">Dynamic Provisioning and StorageClass API</h1>
</div>



<div class="post-content">

   

    

    <a target="_blank"
        href="https://github.com/vmware/vsphere-storage-for-kubernetes/edit/master/documentation//storageclass.md"
        class="btn btn-default githubEditButton" role="button"><i class="fa fa-github fa-lg"></i> Edit me</a>

    

    
    
<!-- this handles the automatic toc. use ## for subheads to auto-generate the on-page minitoc. if you use html tags, you must supply an ID for the heading element in order for it to appear in the minitoc. -->
<script>
$( document ).ready(function() {
  // Handler for .ready() called.

$('#toc').toc({ minimumHeaders: 0, listType: 'ul', showSpeed: 0, headers: 'h2,h3,h4' });

/* this offset helps account for the space taken up by the floating toolbar. */
$('#toc').on('click', 'a', function() {
  var target = $(this.getAttribute('href'))
    , scroll_target = target.offset().top

  $(window).scrollTop(scroll_target - 10);
  return false
})
  
});
</script>

<div id="toc"></div>

    

  <p>With PV and PVCs one can only provision storage statically i.e. PVs first needs to be created before a Pod claims it. However, with StorageClass API Kubernetes enables dynamic volume provisioning. This avoids pre-provisioning of storage and storage is provisioned automatically when a user requests it.</p>

<p>StorageClass API object specifies a provisioner and parameters  which are used to decide which volume plugin to be used and provisioner specific parameters.
Provisioner could be AWS EBS, vSphere, OpenStack and so on.</p>

<p>vSphere is one of the provisioners and it allows following parameters:</p>

<ul>
  <li>
    <p><strong>diskformat</strong> which can be thin(default), zeroedthick and eagerzeroedthick</p>
  </li>
  <li>
    <p><strong>datastore</strong> is an optional field which can be VMFSDatastore or VSANDatastore. This allows user to select the datastore to provision PV from, if not specified the default datastore from vSphere config file is used.</p>
  </li>
  <li>
    <p><strong>storagePolicyName</strong> is an optional field which is the name of the SPBM policy to be applied. The newly created persistent volume will have the SPBM policy configured with it.</p>
  </li>
  <li>
    <p><strong>VSAN Storage Capability Parameters</strong> (cacheReservation, diskStripes, forceProvisioning, hostFailuresToTolerate, iopsLimit and objectSpaceReservation) are supported by vSphere provisioner for vSAN storage. The persistent volume created with these parameters will have these vSAN storage capabilities configured with it. For more detail about these parameters go to <a href="https://vmware.github.io/vsphere-storage-for-kubernetes/documentation/policy-based-mgmt.html">Storage Policy Management section</a>.</p>
  </li>
</ul>

<p><strong>Note:</strong></p>

<p>All the example yamls can be found <a href="https://github.com/kubernetes/examples/tree/master/staging/volumes/vsphere">here</a> unless otherwise specified. Please download these examples.</p>

<p>Let us look at an example of how to use StorageClass for dynamic provisioning.</p>

<p><strong>Note:</strong> With StorageClass, VMDK need not be created manually for Persistent Volume. VMDK will be created dynamically by <code class="highlighter-rouge">vsphere-volume</code> provisioner.</p>

<p><strong>Create Storage Class</strong></p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ cat vsphere-volume-sc-fast.yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata: 
  name: fast
provisioner: kubernetes.io/vsphere-volume
parameters: 
  datastore: VSANDatastore
  diskformat: thin
  fstype: ext3
</code></pre>
</div>

<p>For Kubernetes version 1.8.X or older, if datastore is a member of datastore Cluster or within some subfolder, the datastore folder path needs to be provided in the datastore parameter as below.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>   datastore:	DatastoreCluster/VSANDatastore
</code></pre>
</div>
<p>For Kubernetes version 1.9.X datastore name is sufficient to identify the datastore.</p>

<p><strong>Create the Storageclass</strong></p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ kubectl create -f examples/volumes/vsphere/vsphere-volume-sc-fast.yaml
</code></pre>
</div>

<p><strong>Verify storage class is created</strong></p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ kubectl describe storageclass fast
Name:           fast
IsDefaultClass: No
Annotations:    &lt;none&gt;
Provisioner:    kubernetes.io/vsphere-volume
Parameters:     diskformat=thin,fstype=ext3,datastore=VSANDatastore
No events.
</code></pre>
</div>

<p><strong>Create Persistent Volume Claim</strong></p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ cat vsphere-volume-pvcsc.yaml
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: pvcsc001
  annotations:
    volume.beta.kubernetes.io/storage-class: fast
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 2Gi
</code></pre>
</div>

<p><strong>Create the persistent volume claim</strong></p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ kubectl create -f examples/volumes/vsphere/vsphere-volume-pvcsc.yaml
</code></pre>
</div>

<p><strong>Verify persistent volume claim is created</strong></p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ kubectl describe pvc pvcsc001
Name:           pvcsc001
Namespace:      default
StorageClass:   fast
Status:         Bound
Volume:         pvc-83295256-f8e0-11e6-8263-005056b2349c
Labels:         &lt;none&gt;
Capacity:       2Gi
Access Modes:   RWO
Events:
  FirstSeen LastSeen Count  From        SubObjectPath   Type  Reason Message
  -----------------------------------------------------------
  1m          1m      1   persistentvolume-controller  Normal  Provisioning Succeeded

  Successfully provisioned volume pvc-83295256-f8e0-11e6-8263-005056b2349c using Kubernetes.io/vsphere-volume
</code></pre>
</div>

<p>Persistent Volume is automatically created and is bounded to this pvc.</p>

<p><strong>Verify persistent volume is created</strong></p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ kubectl describe pv pvc-83295256-f8e0-11e6-8263-005056b2349c
Name:           pvc-83295256-f8e0-11e6-8263-005056b2349c
Labels:         &lt;none&gt;
StorageClass:   fast
Status:         Bound
Claim:          default/pvcsc001
Reclaim Policy: Delete
Access Modes:   RWO
Capacity:       2Gi
Message:
Source:
    Type:       vSphereVolume (a Persistent Disk resource in vSphere)
    VolumePath: [VSANDatastore] kubevols/kubernetes-dynamic-pvc-83295256-f8e0-11e6-8263-005056b2349c.vmdk
    FSType:     ext3
No events.
</code></pre>
</div>

<p><strong>Note:</strong> VMDK is created inside kubevols folder in datastore which is mentioned in ‘vsphere’ cloudprovider configuration. The cloudprovider config is created during setup of Kubernetes cluster on vSphere.</p>

<p><strong>Create Pod which uses Persistent Volume Claim with storage class.</strong></p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ cat vsphere-volume-pvcscpod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: pvpod
spec:
  containers:
  - name: test-container
    image: gcr.io/google_containers/test-webserver
    volumeMounts:
    - name: test-volume
      mountPath: /test-vmdk
  volumes:
  - name: test-volume
    persistentVolumeClaim:
      claimName: pvcsc001
</code></pre>
</div>

<p><strong>Create the pod</strong></p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ kubectl create -f vsphere-volume-pvcscpod.yaml
</code></pre>
</div>

<p><strong>Verify pod is created</strong></p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ kubectl get pod pvpod
NAME      READY     STATUS    RESTARTS   AGE
pvpod       1/1      Running   0          48m
</code></pre>
</div>

  

    <div class="tags">
        
    </div>

    

</div>

<footer>
    <div class="row">
        <div class="col-lg-12 footer">
            <div style="float:left;"><img style="max-width:150px;" src="images/company_logo.png" alt="Company logo"/></div>
            <div style="float:right;"></div>&copy;2019 VMWare. All rights reserved.<br />
             Site last generated:
            Apr 5, 2019</div>
        </div>
    </div>
</footer>


    </div>
    <!-- /.row -->
</div>
<!-- /.container -->
    </div>

</body>

</html>