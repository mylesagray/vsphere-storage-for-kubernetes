<!DOCTYPE html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="keywords" content=" ">
<title>Deploying Sharded MongoDB Cluster | vSphere Storage for Kubernetes</title>
<link rel="stylesheet" href="css/syntax.css">


<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
<!--<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">-->
<link rel="stylesheet" href="css/modern-business.css">
<link rel="stylesheet" href="css/infracloudio-lavish-bootstrap.css">
<link rel="stylesheet" href="css/vmware-customstyles.css">
<link rel="stylesheet" href="css/infracloudio-theme-blue.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="js/jquery.navgoco.min.js"></script>


<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/2.0.0/anchor.min.js"></script>
<script src="js/toc.js"></script>
<script src="js/customscripts.js"></script>

<link rel="shortcut icon" href="images/favicon.ico">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link rel="alternate" type="application/rss+xml" title="" href="feed.xml">

    <script>
        $(document).ready(function() {
            // Initialize navgoco with default options
            $("#mysidebar").navgoco({
                caretHtml: '',
                accordion: true,
                openClass: 'active', // open
                save: false, // leave false or nav highlighting doesn't work right
                cookie: {
                    name: 'navgoco',
                    expires: false,
                    path: '/'
                },
                slide: {
                    duration: 400,
                    easing: 'swing'
                }
            });

            $("#collapseAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', false);
            });

            $("#expandAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', true);
            });

        });

    </script>
    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })
    </script>
    

</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container topnavlinks">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="fa fa-home fa-lg navbar-brand" href="index.html">&nbsp;<span class="projectTitle"> vSphere Storage for Kubernetes</span></a>
        </div>
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <!-- entries without drop-downs appear here -->
                
                
                
                <li><a href="index.html">Home</a></li>
                
                
                
                <li><a href="faqs.html">FAQs</a></li>
                
                
                
                <li><a href="contactus.html">Contact Us</a></li>
                
                
                
                <!-- entries with drop-downs appear here -->
                <!-- conditional logic to control which topnav appears for the audience defined in the configuration file.-->
                
                
                <!--comment out this block if you want to hide search-->
                <li>
                    <!--start search-->
                    <div id="search-demo-container">
                        <input type="text" id="search-input" placeholder="search...">
                        <ul id="results-container"></ul>
                    </div>
                    <script src="js/jekyll-search.js" type="text/javascript"></script>
                    <script type="text/javascript">
                            SimpleJekyllSearch.init({
                                searchInput: document.getElementById('search-input'),
                                resultsContainer: document.getElementById('results-container'),
                                dataSource: 'search.json',
                                searchResultTemplate: '<li><a href="{url}" title="Deploying Sharded MongoDB Cluster">{title}</a></li>',
                    noResultsText: 'No results found.',
                            limit: 10,
                            fuzzy: true,
                    })
                    </script>
                    <!--end search-->
                </li>
            </ul>
        </div>
        </div>
        <!-- /.container -->
</nav>

<!-- Page Content -->
<div class="container">
    <div class="col-lg-12">&nbsp;</div>
    <!-- Content Row -->
    <div class="row">
        <!-- Sidebar Column -->
        <div class="col-md-3">

          












<ul id="mysidebar" class="nav">
    <li class="sidebarTitle">Navigation </li>
    
    
    
    <li>
        <a href="#">vSphere Cloud Provider</a>
        <ul>
            
            
            
            <li><a href="index.html">Introduction</a></li>
            
            
            
            
            
            
            <li><a href="overview.html">Overview</a></li>
            
            
            
            <li class="subfolders">
                <a href="#">Provisioning Methods</a>
                <ul>
                    
                    
                    
                    <li><a href="policy-based-mgmt.html">Dynamic Provisioning (Recommended)</a></li>
                    
                    
                    
                    
                    
                    <li><a href="persistent-vols-claims.html">Static Provisioning</a></li>
                    
                    
                    
                </ul>
            </li>
            
            
            
            
            
            
            <li><a href="zones.html">Zone Support</a></li>
            
            
            
            
            
            
            <li><a href="versions.html">Versions</a></li>
            
            
            
            
        </ul>
        
        
    
    <li>
        <a href="#">Deployment</a>
        <ul>
            
            
            
            <li><a href="prerequisites.html">Prerequisites</a></li>
            
            
            
            
            
            
            <li><a href="existing.html">Configuration</a></li>
            
            
            
            
            
            
            <li><a href="vcp-roles.html">Permissions</a></li>
            
            
            
            
        </ul>
        
        
    
    <li>
        <a href="#">Upgrades</a>
        <ul>
            
            
            
            <li><a href="kubernetes-upgrade.html">Upgrade to v1.9.x</a></li>
            
            
            
            
        </ul>
        
        
    
    <li>
        <a href="#">Troubleshooting</a>
        <ul>
            
            
            
            <li><a href="faqs.html">FAQs</a></li>
            
            
            
            
            
            
            <li><a href="known-issues.html">Known Issues</a></li>
            
            
            
            
            
            
            <li><a href="troubleshooting.html">Logs and debugging</a></li>
            
            
            
            
        </ul>
        
        
    
    <li>
        <a href="#">Appendices</a>
        <ul>
            
            
            
            <li><a href="maximum-scale-limit.html">Scaling Limits</a></li>
            
            
            
            
            
            
            <li><a href="saml-token-authentication.html">SAML Authentication</a></li>
            
            
            
            
            
            
            <li><a href="k8s-secret.html">Securing Credentials</a></li>
            
            
            
            
            
            
            <li><a href="high-availability.html">High Availability of Kubernetes Cluster</a></li>
            
            
            
            <li class="subfolders">
                <a href="#">Example Applications</a>
                <ul>
                    
                    
                    
                    <li><a href="guestbook.html">Guestbook</a></li>
                    
                    
                    
                    
                    
                    <li><a href="minio.html">Minio</a></li>
                    
                    
                    
                    
                    
                    <li class="active"><a href="mongodb.html">MongoDB</a></li>
                    
                    
                    
                </ul>
            </li>
            
            
            
            
        </ul>
        
        
        
        <!-- if you aren't using the accordion, uncomment this block:
           <p class="external">
               <a href="#" id="collapseAll">Collapse All</a> | <a href="#" id="expandAll">Expand All</a>
           </p>
           -->
    </li>
</ul>
</div>

<!-- this highlights the active parent class in the navgoco sidebar. this is critical so that the parent expands when you're viewing a page. This must appear below the sidebar code above. Otherwise, if placed inside customscripts.js, the script runs before the sidebar code runs and the class never gets inserted.-->
<script>$("li.active").parents('li').toggleClass("active");</script>

    <!-- Content Column -->
    <div class="col-md-9">
        <div class="post-header">
   <h1 class="post-title-main">Deploying Sharded MongoDB Cluster</h1>
</div>



<div class="post-content">

   

    

    <a target="_blank"
        href="https://github.com/vmware/vsphere-storage-for-kubernetes/edit/master/documentation//mongodb.md"
        class="btn btn-default githubEditButton" role="button"><i class="fa fa-github fa-lg"></i> Edit me</a>

    

    
    
<!-- this handles the automatic toc. use ## for subheads to auto-generate the on-page minitoc. if you use html tags, you must supply an ID for the heading element in order for it to appear in the minitoc. -->
<script>
$( document ).ready(function() {
  // Handler for .ready() called.

$('#toc').toc({ minimumHeaders: 0, listType: 'ul', showSpeed: 0, headers: 'h2,h3,h4' });

/* this offset helps account for the space taken up by the floating toolbar. */
$('#toc').on('click', 'a', function() {
  var target = $(this.getAttribute('href'))
    , scroll_target = target.offset().top

  $(window).scrollTop(scroll_target - 10);
  return false
})
  
});
</script>

<div id="toc"></div>

    

  <p>This section describes the steps to create persistent storage for containers to be consumed by MongoDB services on vSAN. After these steps are completed, Cloud Provider will create the virtual disks (volumes in Kubernetes) and mount them to the Kubernetes nodes automatically. The virtual disks are created with the vSAN default policy.</p>

<h2 id="define-storageclass">Define StorageClass</h2>

<p>A StorageClass provides a mechanism for the administrators to describe the “classes” of storage they offer. Different classes map to quality-of-service levels, or to backup policies, or to arbitrary policies determined by the cluster administrators. The YAML format defines a “platinum” level StorageClass.</p>

<div class="language-yaml highlighter-rouge"><pre class="highlight"><code><span class="s">kind</span><span class="pi">:</span> <span class="s">StorageClass</span>
<span class="s">apiVersion</span><span class="pi">:</span> <span class="s">storage.k8s.io/v1</span>
<span class="s">metadata</span><span class="pi">:</span>
 <span class="s">name</span><span class="pi">:</span> <span class="s">platinum</span>
<span class="s">provisioner</span><span class="pi">:</span> <span class="s">kubernetes.io/vsphere-volume</span>
<span class="s">parameters</span><span class="pi">:</span>
 <span class="s">diskformat</span><span class="pi">:</span> <span class="s">thin</span>
</code></pre>
</div>

<p><strong>Note:</strong> Although all volumes are created on the same vSAN datastore, user can adjust the policy according to actual storage capability requirement by modifying the vSAN policy in vCenter Server. User can also specify VSAN storage capabilities in StorageClass definition based on this application needs.</p>

<h2 id="claim-persistent-volume">Claim Persistent Volume</h2>

<p>A PersistentVolumeClaim (PVC) is a request for storage by a user. Claims can request specific size and access modes (for example, can be mounted once read/write or many times read-only). The YAML format claims a 128GB volume with read and write capability.</p>

<div class="language-yaml highlighter-rouge"><pre class="highlight"><code><span class="s">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="s">kind</span><span class="pi">:</span> <span class="s">PersistentVolumeClaim</span>
<span class="s">metadata</span><span class="pi">:</span>
 <span class="s">name</span><span class="pi">:</span> <span class="s">pvc128gb</span>
 <span class="s">annotations</span><span class="pi">:</span>
  <span class="s">volume.beta.kubernetes.io/storage-class</span><span class="pi">:</span> <span class="s2">"</span><span class="s">platinum"</span>
<span class="s">spec</span><span class="pi">:</span>
 <span class="s">accessModes</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">ReadWriteOnce</span>
 <span class="s">resources</span><span class="pi">:</span>
  <span class="s">requests</span><span class="pi">:</span>
   <span class="s">storage</span><span class="pi">:</span> <span class="s">128Gi</span>
</code></pre>
</div>

<h2 id="specify-the-volume-to-be-mounted-for-the-consumption-by-the-containers">Specify the Volume to be Mounted for the Consumption by the Containers</h2>

<p>The YAML format specifies a MongoDB 3.4 image to use the volume from Step 2 and mount it to path
/data/db.</p>

<div class="language-yaml highlighter-rouge"><pre class="highlight"><code><span class="s">spec</span><span class="pi">:</span>
     <span class="s">containers</span><span class="pi">:</span>
     <span class="pi">-</span> <span class="s">image</span><span class="pi">:</span> <span class="s">mongo:3.4</span>
       <span class="s">name</span><span class="pi">:</span> <span class="s">mongo-ps</span>
       <span class="s">ports</span><span class="pi">:</span>
       <span class="pi">-</span> <span class="s">name</span><span class="pi">:</span> <span class="s">mongo-ps</span>
        <span class="s">containerPort</span><span class="pi">:</span> <span class="s">27017</span>
          <span class="s">hostPort</span><span class="pi">:</span> <span class="s">27017</span>
       <span class="s">volumeMounts</span><span class="pi">:</span>
       <span class="pi">-</span> <span class="s">name</span><span class="pi">:</span> <span class="s">pvc-128gb</span>
             <span class="s">mountPath</span><span class="pi">:</span> <span class="s">/data/db</span>
    <span class="s">volumes</span><span class="pi">:</span>
       <span class="pi">-</span> <span class="s">name</span><span class="pi">:</span> <span class="s">pvc-128gb</span>
         <span class="s">persistentVolumeClaim</span><span class="pi">:</span>
              <span class="s">claimName</span><span class="pi">:</span> <span class="s">pvc128gb</span>
</code></pre>
</div>

<p>Storage was created and provisioned from vSAN for containers for the MongoDB service by using dynamic provisioning in YAML files. Storage volumes were claimed as persistent ones to preserve the data on the volumes. All mongo servers are combined into one Kubernetes pod per node.</p>

<p>In Kubernetes, as each pod gets one IP address assigned, each service within a pod must have a distinct port. As the mongos are the services by which user can access shard from other applications, the standard MongoDB port 27017 is assigned to them.</p>

<p>Please refer this <a href="https://storagehub.vmware.com/#!/vmware-vsan/vmware-vsan-tm-as-persistent-storage-for-mongodb-in-containers">Reference Architecture</a> for detailed understanding of how persistent storage for containers is consumed by MongoDB services on vSAN.</p>

<p>Download the yaml files for deploying MondoDB on Kubernetes with vSphere Cloud Provider from <a href="https://github.com/vmware/kubernetes/tree/kube-examples/kube-examples/guestbook/guestbook-storageclass">here</a></p>

<p>To understand the configuration mentioned in these YAMLs please refer this <a href="https://storagehub.vmware.com/#!/vmware-vsan/vmware-vsan-tm-as-persistent-storage-for-mongodb-in-containers/mongodb-deployment">link</a></p>

<p>Execute following commands to deploy Sharded MongoDB Cluster on Kubernetes with vSphere Cloud Provider.</p>

<h2 id="create-storageclass">Create StorageClass</h2>

<div class="language-sh highlighter-rouge"><pre class="highlight"><code>kubectl create -f https://raw.githubusercontent.com/vmware/kubernetes/kube-examples/kube-examples/mongodb-shards/storageclass.yaml
</code></pre>
</div>

<h2 id="create-storage-volumes-for-shared-mondodb-cluster">Create Storage Volumes for Shared MondoDB Cluster</h2>

<div class="language-sh highlighter-rouge"><pre class="highlight"><code>kubectl create -f https://github.com/vmware/kubernetes/blob/kube-examples/kube-examples/mongodb-shards/storage-volumes-node01.yaml
kubectl create -f https://github.com/vmware/kubernetes/blob/kube-examples/kube-examples/mongodb-shards/storage-volumes-node02.yaml
kubectl create -f https://github.com/vmware/kubernetes/blob/kube-examples/kube-examples/mongodb-shards/storage-volumes-node03.yaml
kubectl create -f https://github.com/vmware/kubernetes/blob/kube-examples/kube-examples/mongodb-shards/storage-volumes-node03.yaml
</code></pre>
</div>

<h2 id="create-mongodb-pods">Create MongoDB Pods</h2>

<div class="language-sh highlighter-rouge"><pre class="highlight"><code>kubectl create -f https://raw.githubusercontent.com/vmware/kubernetes/kube-examples/kube-examples/mongodb-shards/node01-deployment.yaml
kubectl create -f https://raw.githubusercontent.com/vmware/kubernetes/kube-examples/kube-examples/mongodb-shards/node02-deployment.yaml
kubectl create -f https://raw.githubusercontent.com/vmware/kubernetes/kube-examples/kube-examples/mongodb-shards/node03-deployment.yaml
kubectl create -f https://raw.githubusercontent.com/vmware/kubernetes/kube-examples/kube-examples/mongodb-shards/node03-deployment.yaml
</code></pre>
</div>

<h2 id="create-services">Create Services</h2>

<div class="language-sh highlighter-rouge"><pre class="highlight"><code>kubectl create -f https://raw.githubusercontent.com/vmware/kubernetes/kube-examples/kube-examples/mongodb-shards/node01-service.yaml
kubectl create -f https://raw.githubusercontent.com/vmware/kubernetes/kube-examples/kube-examples/mongodb-shards/node02-service.yaml
kubectl create -f https://raw.githubusercontent.com/vmware/kubernetes/kube-examples/kube-examples/mongodb-shards/node03-service.yaml
kubectl create -f https://raw.githubusercontent.com/vmware/kubernetes/kube-examples/kube-examples/mongodb-shards/node04-service.yaml
</code></pre>
</div>

  

    <div class="tags">
        
    </div>

    

</div>

<footer>
    <div class="row">
        <div class="col-lg-12 footer">
            <div style="float:left;"><img style="max-width:150px;" src="images/company_logo.png" alt="Company logo"/></div>
            <div style="float:right;"></div>&copy;2019 VMWare. All rights reserved.<br />
             Site last generated:
            May 30, 2019</div>
        </div>
    </div>
</footer>


    </div>
    <!-- /.row -->
</div>
<!-- /.container -->
    </div>

</body>

</html>