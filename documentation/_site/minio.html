<!DOCTYPE html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="keywords" content=" ">
<title>Deploying S3 Stateful Containers - Minio | vSphere Storage for Kubernetes</title>
<link rel="stylesheet" href="css/syntax.css">


<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
<!--<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">-->
<link rel="stylesheet" href="css/modern-business.css">
<link rel="stylesheet" href="css/infracloudio-lavish-bootstrap.css">
<link rel="stylesheet" href="css/vmware-customstyles.css">
<link rel="stylesheet" href="css/infracloudio-theme-blue.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="js/jquery.navgoco.min.js"></script>


<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/2.0.0/anchor.min.js"></script>
<script src="js/toc.js"></script>
<script src="js/customscripts.js"></script>

<link rel="shortcut icon" href="images/favicon.ico">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link rel="alternate" type="application/rss+xml" title="" href="feed.xml">

    <script>
        $(document).ready(function() {
            // Initialize navgoco with default options
            $("#mysidebar").navgoco({
                caretHtml: '',
                accordion: true,
                openClass: 'active', // open
                save: false, // leave false or nav highlighting doesn't work right
                cookie: {
                    name: 'navgoco',
                    expires: false,
                    path: '/'
                },
                slide: {
                    duration: 400,
                    easing: 'swing'
                }
            });

            $("#collapseAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', false);
            });

            $("#expandAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', true);
            });

        });

    </script>
    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })
    </script>
    

</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container topnavlinks">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="fa fa-home fa-lg navbar-brand" href="index.html">&nbsp;<span class="projectTitle"> vSphere Storage for Kubernetes</span></a>
        </div>
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <!-- entries without drop-downs appear here -->
                
                
                
                <li><a href="index.html">Home</a></li>
                
                
                
                <li><a href="faqs.html">FAQs</a></li>
                
                
                
                <li><a href="contactus.html">Contact Us</a></li>
                
                
                
                <!-- entries with drop-downs appear here -->
                <!-- conditional logic to control which topnav appears for the audience defined in the configuration file.-->
                
                
                <!--comment out this block if you want to hide search-->
                <li>
                    <!--start search-->
                    <div id="search-demo-container">
                        <input type="text" id="search-input" placeholder="search...">
                        <ul id="results-container"></ul>
                    </div>
                    <script src="js/jekyll-search.js" type="text/javascript"></script>
                    <script type="text/javascript">
                            SimpleJekyllSearch.init({
                                searchInput: document.getElementById('search-input'),
                                resultsContainer: document.getElementById('results-container'),
                                dataSource: 'search.json',
                                searchResultTemplate: '<li><a href="{url}" title="Deploying S3 Stateful Containers - Minio">{title}</a></li>',
                    noResultsText: 'No results found.',
                            limit: 10,
                            fuzzy: true,
                    })
                    </script>
                    <!--end search-->
                </li>
            </ul>
        </div>
        </div>
        <!-- /.container -->
</nav>

<!-- Page Content -->
<div class="container">
    <div class="col-lg-12">&nbsp;</div>
    <!-- Content Row -->
    <div class="row">
        <!-- Sidebar Column -->
        <div class="col-md-3">

          












<ul id="mysidebar" class="nav">
    <li class="sidebarTitle">Navigation </li>
    
    
    
    <li>
        <a href="#">vSphere Cloud Provider</a>
        <ul>
            
            
            
            <li><a href="index.html">Introduction</a></li>
            
            
            
            
            
            
            <li><a href="overview.html">Overview</a></li>
            
            
            
            <li class="subfolders">
                <a href="#">Provisioning Methods</a>
                <ul>
                    
                    
                    
                    <li><a href="policy-based-mgmt.html">Dynamic Provisioning (Recommended)</a></li>
                    
                    
                    
                    
                    
                    <li><a href="persistent-vols-claims.html">Static Provisioning</a></li>
                    
                    
                    
                    
                    
                    <li><a href="zones.html">Zone support</a></li>
                    
                    
                    
                </ul>
            </li>
            
            
            
            
            
            
            <li><a href="zones.html">Zone Support</a></li>
            
            
            
            
            
            
            <li><a href="versions.html">Versions</a></li>
            
            
            
            
        </ul>
        
        
    
    <li>
        <a href="#">Deployment</a>
        <ul>
            
            
            
            <li><a href="prerequisites.html">Prerequisites</a></li>
            
            
            
            
            
            
            <li><a href="existing.html">Configuration</a></li>
            
            
            
            
            
            
            <li><a href="vcp-roles.html">Permissions</a></li>
            
            
            
            
        </ul>
        
        
    
    <li>
        <a href="#">Upgrades</a>
        <ul>
            
            
            
            <li><a href="kubernetes-upgrade.html">Upgrade to v1.9.x</a></li>
            
            
            
            
        </ul>
        
        
    
    <li>
        <a href="#">Troubleshooting</a>
        <ul>
            
            
            
            <li><a href="faqs.html">FAQs</a></li>
            
            
            
            
            
            
            <li><a href="known-issues.html">Known Issues</a></li>
            
            
            
            
            
            
            <li><a href="troubleshooting.html">Logs and debugging</a></li>
            
            
            
            
        </ul>
        
        
    
    <li>
        <a href="#">Appendices</a>
        <ul>
            
            
            
            <li><a href="maximum-scale-limit.html">Scaling Limits</a></li>
            
            
            
            
            
            
            <li><a href="saml-token-authentication.html">SAML Authentication</a></li>
            
            
            
            
            
            
            <li><a href="k8s-secret.html">Securing Credentials</a></li>
            
            
            
            
            
            
            <li><a href="high-availability.html">High Availability of Kubernetes Cluster</a></li>
            
            
            
            <li class="subfolders">
                <a href="#">Example Applications</a>
                <ul>
                    
                    
                    
                    <li><a href="guestbook.html">Guestbook</a></li>
                    
                    
                    
                    
                    
                    <li class="active"><a href="minio.html">Minio</a></li>
                    
                    
                    
                    
                    
                    <li><a href="mongodb.html">MongoDB</a></li>
                    
                    
                    
                </ul>
            </li>
            
            
            
            
        </ul>
        
        
        
        <!-- if you aren't using the accordion, uncomment this block:
           <p class="external">
               <a href="#" id="collapseAll">Collapse All</a> | <a href="#" id="expandAll">Expand All</a>
           </p>
           -->
    </li>
</ul>
</div>

<!-- this highlights the active parent class in the navgoco sidebar. this is critical so that the parent expands when you're viewing a page. This must appear below the sidebar code above. Otherwise, if placed inside customscripts.js, the script runs before the sidebar code runs and the class never gets inserted.-->
<script>$("li.active").parents('li').toggleClass("active");</script>

    <!-- Content Column -->
    <div class="col-md-9">
        <div class="post-header">
   <h1 class="post-title-main">Deploying S3 Stateful Containers - Minio</h1>
</div>



<div class="post-content">

   

    

    <a target="_blank"
        href="https://github.com/vmware/vsphere-storage-for-kubernetes/edit/master/documentation//minio.md"
        class="btn btn-default githubEditButton" role="button"><i class="fa fa-github fa-lg"></i> Edit me</a>

    

    
    
<!-- this handles the automatic toc. use ## for subheads to auto-generate the on-page minitoc. if you use html tags, you must supply an ID for the heading element in order for it to appear in the minitoc. -->
<script>
$( document ).ready(function() {
  // Handler for .ready() called.

$('#toc').toc({ minimumHeaders: 0, listType: 'ul', showSpeed: 0, headers: 'h2,h3,h4' });

/* this offset helps account for the space taken up by the floating toolbar. */
$('#toc').on('click', 'a', function() {
  var target = $(this.getAttribute('href'))
    , scroll_target = target.offset().top

  $(window).scrollTop(scroll_target - 10);
  return false
})
  
});
</script>

<div id="toc"></div>

    

  <p>This case study describes the process to deploy distributed Minio server on Kubernetes. This example uses the official Minio Docker image from Docker Hub.</p>

<h2 id="create-minio-storageclass">Create Minio StorageClass</h2>

<div class="language-yaml highlighter-rouge"><pre class="highlight"><code><span class="c1">#minio-sc.yaml</span>

<span class="s">kind</span><span class="pi">:</span> <span class="s">StorageClass</span>
<span class="s">apiVersion</span><span class="pi">:</span> <span class="s">storage.k8s.io/v1</span>
<span class="s">metadata</span><span class="pi">:</span>
  <span class="s">name</span><span class="pi">:</span> <span class="s">miniosc</span>
<span class="s">provisioner</span><span class="pi">:</span> <span class="s">kubernetes.io/vsphere-volume</span>
<span class="s">parameters</span><span class="pi">:</span>
    <span class="s">diskformat</span><span class="pi">:</span> <span class="s">thin</span>

</code></pre>
</div>

<p>Creating the storage class:</p>

<div class="language-sh highlighter-rouge"><pre class="highlight"><code>kubectl create -f minio-sc.yaml
</code></pre>
</div>

<h2 id="create-minio-headless-service">Create Minio Headless Service</h2>

<p>Headless Service controls the domain within which StatefulSets are created. The domain managed by this Service takes the form: $(service name).$(namespace).svc.cluster.local (where “cluster.local” is the cluster domain), and the pods in this domain take the form: $(pod-name-{i}).$(service name).$(namespace).svc.cluster.local. This is required to get a DNS resolvable URL for each of the pods created within the Statefulset.</p>

<p>This is the Headless service description.</p>

<div class="language-yaml highlighter-rouge"><pre class="highlight"><code><span class="s">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="s">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="s">metadata</span><span class="pi">:</span>
  <span class="s">name</span><span class="pi">:</span> <span class="s">minio</span>
  <span class="s">labels</span><span class="pi">:</span>
    <span class="s">app</span><span class="pi">:</span> <span class="s">minio</span>
<span class="s">spec</span><span class="pi">:</span>
  <span class="s">clusterIP</span><span class="pi">:</span> <span class="s">None</span>
  <span class="s">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">port</span><span class="pi">:</span> <span class="s">9000</span>
      <span class="s">name</span><span class="pi">:</span> <span class="s">minio</span>
  <span class="s">selector</span><span class="pi">:</span>
    <span class="s">app</span><span class="pi">:</span> <span class="s">minio</span>
</code></pre>
</div>

<p>Create the headless service</p>

<div class="language-sh highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>kubectl create -f https://github.com/vmware/kubernetes/tree/kube-examples/kube-examples/minio/distributed/minio-distributed-headless-service.yaml?raw<span class="o">=</span><span class="nb">true
</span>service <span class="s2">"minio"</span> created
</code></pre>
</div>

<h2 id="create-minio-statefulset">Create Minio StatefulSet</h2>

<p>A StatefulSet provides a deterministic name and a unique identity to each pod, making it easy to deploy stateful distributed applications. To launch distributed Minio user need to pass drive locations as parameters to the minio server command. Then the user need to run the same command on all the participating pods. StatefulSets offer a perfect way to handle this requirement.
This is the Statefulset description.</p>

<div class="language-yaml highlighter-rouge"><pre class="highlight"><code><span class="s">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1beta1</span>
<span class="s">kind</span><span class="pi">:</span> <span class="s">StatefulSet</span>
<span class="s">metadata</span><span class="pi">:</span>
  <span class="s">name</span><span class="pi">:</span> <span class="s">minio</span>
<span class="s">spec</span><span class="pi">:</span>
  <span class="s">serviceName</span><span class="pi">:</span> <span class="s">minio</span>
  <span class="s">replicas</span><span class="pi">:</span> <span class="s">4</span>
  <span class="s">template</span><span class="pi">:</span>
    <span class="s">metadata</span><span class="pi">:</span>
      <span class="s">annotations</span><span class="pi">:</span>
        <span class="s">pod.alpha.kubernetes.io/initialized</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
      <span class="s">labels</span><span class="pi">:</span>
        <span class="s">app</span><span class="pi">:</span> <span class="s">minio</span>
    <span class="s">spec</span><span class="pi">:</span>
      <span class="s">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">name</span><span class="pi">:</span> <span class="s">minio</span>
        <span class="s">env</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">name</span><span class="pi">:</span> <span class="s">MINIO_ACCESS_KEY</span>
          <span class="s">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">minio"</span>
        <span class="pi">-</span> <span class="s">name</span><span class="pi">:</span> <span class="s">MINIO_SECRET_KEY</span>
          <span class="s">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">minio123"</span>
        <span class="s">image</span><span class="pi">:</span> <span class="s">minio/minio:RELEASE.2017-05-05T01-14-51Z</span>
        <span class="s">args</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">server</span>
        <span class="pi">-</span> <span class="s">http://minio-0.minio.default.svc.cluster.local/data</span>
        <span class="pi">-</span> <span class="s">http://minio-1.minio.default.svc.cluster.local/data</span>
        <span class="pi">-</span> <span class="s">http://minio-2.minio.default.svc.cluster.local/data</span>
        <span class="pi">-</span> <span class="s">http://minio-3.minio.default.svc.cluster.local/data</span>
        <span class="s">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">containerPort</span><span class="pi">:</span> <span class="s">9000</span>
          <span class="s">hostPort</span><span class="pi">:</span> <span class="s">9000</span>
        <span class="c1"># These volume mounts are persistent. Each pod in the PetSet</span>
        <span class="c1"># gets a volume mounted based on this field.</span>
        <span class="s">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">name</span><span class="pi">:</span> <span class="s">data</span>
          <span class="s">mountPath</span><span class="pi">:</span> <span class="s">/data</span>
  <span class="c1"># These are converted to volume claims by the controller</span>
  <span class="c1"># and mounted at the paths mentioned above.</span>
  <span class="s">volumeClaimTemplates</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">metadata</span><span class="pi">:</span>
      <span class="s">name</span><span class="pi">:</span> <span class="s">data</span>
      <span class="s">annotations</span><span class="pi">:</span>
        <span class="s">volume.beta.kubernetes.io/storage-class</span><span class="pi">:</span> <span class="s">miniosc</span>
    <span class="s">spec</span><span class="pi">:</span>
      <span class="s">accessModes</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">ReadWriteOnce</span>
      <span class="s">resources</span><span class="pi">:</span>
        <span class="s">requests</span><span class="pi">:</span>
          <span class="s">storage</span><span class="pi">:</span> <span class="s">5Gi</span>
</code></pre>
</div>

<p>Create the Statefulset</p>

<div class="language-sh highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>kubectl create -f https://github.com/vmware/kubernetes/tree/kube-examples/kube-examples/minio/distributed/minio-distributed-statefulset.yaml?raw<span class="o">=</span><span class="nb">true
</span>statefulset <span class="s2">"minio"</span> created
</code></pre>
</div>

<h2 id="expose-service-using-nodeport">Expose Service using NodePort</h2>

<p>Now that a Minio statefulset running, user may either want to access it internally (within the cluster) or expose it as a Service onto an external (outside of the cluster, maybe public internet) IP address, depending on the use case. This can be achieved using Services.</p>

<p>There are 3 major service types — default type is ClusterIP, which exposes a service to connection from inside the cluster. NodePort and LoadBalancer are two types that expose services to external traffic.</p>

<p>In this example, we expose the Minio Deployment by using NodePort. This is the service description.</p>

<div class="language-yaml highlighter-rouge"><pre class="highlight"><code><span class="c1">#minio_NodePort.yaml</span>

<span class="s">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="s">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="s">metadata</span><span class="pi">:</span>
  <span class="s">name</span><span class="pi">:</span> <span class="s">minio-service</span>
<span class="s">spec</span><span class="pi">:</span>
  <span class="s">type</span><span class="pi">:</span> <span class="s">NodePort</span>
  <span class="s">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">port</span><span class="pi">:</span> <span class="s">9000</span>
      <span class="s">nodePort</span><span class="pi">:</span> <span class="s">30000</span>
  <span class="s">selector</span><span class="pi">:</span>
    <span class="s">app</span><span class="pi">:</span> <span class="s">minio</span>
</code></pre>
</div>

<div class="language-sh highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>kubectl create -f minio_NodePort.yaml
service <span class="s2">"minio-service"</span> created
</code></pre>
</div>

<h2 id="access-minio">Access Minio</h2>

<p>Find the IP addresses of master nodes</p>

<div class="language-sh highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>kubectl describe node master | grep Addresses
Addresses:		10.160.132.97,10.160.132.97,master
</code></pre>
</div>

<p>Find the NodePort</p>

<div class="language-sh highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>kubectl describe service minio-service | grep NodePort
Type:			NodePort
NodePort:		&lt;<span class="nb">unset</span>&gt;	30000/TCP
</code></pre>
</div>

<p>Use the following URL to access Mnio
<code class="highlighter-rouge">
http://10.160.132.97:30000/minio/login
</code></p>

  

    <div class="tags">
        
    </div>

    

</div>

<footer>
    <div class="row">
        <div class="col-lg-12 footer">
            <div style="float:left;"><img style="max-width:150px;" src="images/company_logo.png" alt="Company logo"/></div>
            <div style="float:right;"></div>&copy;2019 VMWare. All rights reserved.<br />
             Site last generated:
            May 30, 2019</div>
        </div>
    </div>
</footer>


    </div>
    <!-- /.row -->
</div>
<!-- /.container -->
    </div>

</body>

</html>