<!DOCTYPE html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="keywords" content=" ">
<title>Dynamic Provisioning | vSphere Storage for Kubernetes</title>
<link rel="stylesheet" href="css/syntax.css">


<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
<!--<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">-->
<link rel="stylesheet" href="css/modern-business.css">
<link rel="stylesheet" href="css/infracloudio-lavish-bootstrap.css">
<link rel="stylesheet" href="css/vmware-customstyles.css">
<link rel="stylesheet" href="css/infracloudio-theme-blue.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="js/jquery.navgoco.min.js"></script>


<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/2.0.0/anchor.min.js"></script>
<script src="js/toc.js"></script>
<script src="js/customscripts.js"></script>

<link rel="shortcut icon" href="images/favicon.ico">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link rel="alternate" type="application/rss+xml" title="" href="feed.xml">

    <script>
        $(document).ready(function() {
            // Initialize navgoco with default options
            $("#mysidebar").navgoco({
                caretHtml: '',
                accordion: true,
                openClass: 'active', // open
                save: false, // leave false or nav highlighting doesn't work right
                cookie: {
                    name: 'navgoco',
                    expires: false,
                    path: '/'
                },
                slide: {
                    duration: 400,
                    easing: 'swing'
                }
            });

            $("#collapseAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', false);
            });

            $("#expandAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', true);
            });

        });

    </script>
    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })
    </script>
    

</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container topnavlinks">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="fa fa-home fa-lg navbar-brand" href="index.html">&nbsp;<span class="projectTitle"> vSphere Storage for Kubernetes</span></a>
        </div>
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <!-- entries without drop-downs appear here -->
                
                
                
                <li><a href="index.html">Home</a></li>
                
                
                
                <li><a href="faqs.html">FAQs</a></li>
                
                
                
                <li><a href="contactus.html">Contact Us</a></li>
                
                
                
                <!-- entries with drop-downs appear here -->
                <!-- conditional logic to control which topnav appears for the audience defined in the configuration file.-->
                
                
                <!--comment out this block if you want to hide search-->
                <li>
                    <!--start search-->
                    <div id="search-demo-container">
                        <input type="text" id="search-input" placeholder="search...">
                        <ul id="results-container"></ul>
                    </div>
                    <script src="js/jekyll-search.js" type="text/javascript"></script>
                    <script type="text/javascript">
                            SimpleJekyllSearch.init({
                                searchInput: document.getElementById('search-input'),
                                resultsContainer: document.getElementById('results-container'),
                                dataSource: 'search.json',
                                searchResultTemplate: '<li><a href="{url}" title="Dynamic Provisioning">{title}</a></li>',
                    noResultsText: 'No results found.',
                            limit: 10,
                            fuzzy: true,
                    })
                    </script>
                    <!--end search-->
                </li>
            </ul>
        </div>
        </div>
        <!-- /.container -->
</nav>

<!-- Page Content -->
<div class="container">
    <div class="col-lg-12">&nbsp;</div>
    <!-- Content Row -->
    <div class="row">
        <!-- Sidebar Column -->
        <div class="col-md-3">

          












<ul id="mysidebar" class="nav">
    <li class="sidebarTitle">Navigation </li>
    
    
    
    <li>
        <a href="#">vSphere Cloud Provider</a>
        <ul>
            
            
            
            <li><a href="index.html">Introduction</a></li>
            
            
            
            
            
            
            <li><a href="overview.html">Overview</a></li>
            
            
            
            <li class="subfolders">
                <a href="#">Provisioning Methods</a>
                <ul>
                    
                    
                    
                    <li class="active"><a href="policy-based-mgmt.html">Dynamic Provisioning (Recommended)</a></li>
                    
                    
                    
                    
                    
                    <li><a href="persistent-vols-claims.html">Static Provisioning</a></li>
                    
                    
                    
                </ul>
            </li>
            
            
            
            
            
            
            <li><a href="zones.html">Zone Support</a></li>
            
            
            
            
            
            
            <li><a href="versions.html">Versions</a></li>
            
            
            
            
        </ul>
        
        
    
    <li>
        <a href="#">Deployment</a>
        <ul>
            
            
            
            <li><a href="prerequisites.html">Prerequisites</a></li>
            
            
            
            
            
            
            <li><a href="existing.html">Configuration</a></li>
            
            
            
            
            
            
            <li><a href="vcp-roles.html">Permissions</a></li>
            
            
            
            
        </ul>
        
        
    
    <li>
        <a href="#">Upgrades</a>
        <ul>
            
            
            
            <li><a href="kubernetes-upgrade.html">Upgrade to v1.9.x</a></li>
            
            
            
            
        </ul>
        
        
    
    <li>
        <a href="#">Troubleshooting</a>
        <ul>
            
            
            
            <li><a href="faqs.html">FAQs</a></li>
            
            
            
            
            
            
            <li><a href="known-issues.html">Known Issues</a></li>
            
            
            
            
            
            
            <li><a href="troubleshooting.html">Logs and debugging</a></li>
            
            
            
            
        </ul>
        
        
    
    <li>
        <a href="#">Appendices</a>
        <ul>
            
            
            
            <li><a href="maximum-scale-limit.html">Scaling Limits</a></li>
            
            
            
            
            
            
            <li><a href="saml-token-authentication.html">SAML Authentication</a></li>
            
            
            
            
            
            
            <li><a href="k8s-secret.html">Securing Credentials</a></li>
            
            
            
            
            
            
            <li><a href="high-availability.html">High Availability of Kubernetes Cluster</a></li>
            
            
            
            <li class="subfolders">
                <a href="#">Example Applications</a>
                <ul>
                    
                    
                    
                    <li><a href="guestbook.html">Guestbook</a></li>
                    
                    
                    
                    
                    
                    <li><a href="minio.html">Minio</a></li>
                    
                    
                    
                    
                    
                    <li><a href="mongodb.html">MongoDB</a></li>
                    
                    
                    
                </ul>
            </li>
            
            
            
            
        </ul>
        
        
        
        <!-- if you aren't using the accordion, uncomment this block:
           <p class="external">
               <a href="#" id="collapseAll">Collapse All</a> | <a href="#" id="expandAll">Expand All</a>
           </p>
           -->
    </li>
</ul>
</div>

<!-- this highlights the active parent class in the navgoco sidebar. this is critical so that the parent expands when you're viewing a page. This must appear below the sidebar code above. Otherwise, if placed inside customscripts.js, the script runs before the sidebar code runs and the class never gets inserted.-->
<script>$("li.active").parents('li').toggleClass("active");</script>

    <!-- Content Column -->
    <div class="col-md-9">
        <div class="post-header">
   <h1 class="post-title-main">Dynamic Provisioning</h1>
</div>



<div class="post-content">

   

    

    <a target="_blank"
        href="https://github.com/vmware/vsphere-storage-for-kubernetes/edit/master/documentation//policy-based-mgmt.md"
        class="btn btn-default githubEditButton" role="button"><i class="fa fa-github fa-lg"></i> Edit me</a>

    

    
    
<!-- this handles the automatic toc. use ## for subheads to auto-generate the on-page minitoc. if you use html tags, you must supply an ID for the heading element in order for it to appear in the minitoc. -->
<script>
$( document ).ready(function() {
  // Handler for .ready() called.

$('#toc').toc({ minimumHeaders: 0, listType: 'ul', showSpeed: 0, headers: 'h2,h3,h4' });

/* this offset helps account for the space taken up by the floating toolbar. */
$('#toc').on('click', 'a', function() {
  var target = $(this.getAttribute('href'))
    , scroll_target = target.offset().top

  $(window).scrollTop(scroll_target - 10);
  return false
})
  
});
</script>

<div id="toc"></div>

    

  <h2 id="overview">Overview</h2>

<p>One of the most important features of vSphere is <code class="highlighter-rouge">Storage Policy based Management</code> (<code class="highlighter-rouge">SPBM</code>). <code class="highlighter-rouge">SPBM</code> provides a single unified control plane across a broad range of data services and storage solutions. <code class="highlighter-rouge">SPBM</code> enables vSphere administrators to overcome upfront storage provisioning challenges, such as capacity planning, differentiated service levels and managing capacity headroom.</p>

<p>Kubernetes <code class="highlighter-rouge">StorageClasses</code> allow the creation of <code class="highlighter-rouge">PersistentVolumes</code> on-demand without having to create storage and mount it into K8s nodes upfront. <code class="highlighter-rouge">StorageClasses</code> specifiy a <code class="highlighter-rouge">provisioner</code> and <code class="highlighter-rouge">parameters</code> which are used to define the intended policy for a <code class="highlighter-rouge">PersistentVolume</code> which will be dynamically provisioned.</p>

<p>Existing <code class="highlighter-rouge">SPBM</code> policies can be used to configure a <code class="highlighter-rouge">PersistentVolume</code> with a specific policy via the <code class="highlighter-rouge">storagePolicyName</code> parameter.</p>

<h2 id="kubernetes-storageclass">Kubernetes StorageClass</h2>

<h3 id="vmfs-and-nfs">VMFS and NFS</h3>

<p>The admin specifies the SPBM policy - <code class="highlighter-rouge">gold</code> as part of <code class="highlighter-rouge">StorageClass</code> definition for dynamic volume provisioning. When a <code class="highlighter-rouge">PVC</code> is created, the <code class="highlighter-rouge">PersistentVolume</code> will be provisioned on a compatible datastore with the most free space that satisfies the <code class="highlighter-rouge">gold</code> storage policy requirements.</p>

<div class="language-yaml highlighter-rouge"><pre class="highlight"><code><span class="s">$ cat vsphere-volume-spbm-policy.yaml</span>

<span class="s">kind</span><span class="pi">:</span> <span class="s">StorageClass</span>
<span class="s">apiVersion</span><span class="pi">:</span> <span class="s">storage.k8s.io/v1</span>
<span class="s">metadata</span><span class="pi">:</span>
  <span class="s">name</span><span class="pi">:</span> <span class="s">fast</span>
<span class="s">provisioner</span><span class="pi">:</span> <span class="s">kubernetes.io/vsphere-volume</span>
<span class="s">parameters</span><span class="pi">:</span>
    <span class="s">diskformat</span><span class="pi">:</span> <span class="s">zeroedthick</span>
    <span class="s">storagePolicyName</span><span class="pi">:</span> <span class="s">gold</span>
</code></pre>
</div>

<p>The admin can also specify a custom datastore where he wants the volume to be provisioned along with the <code class="highlighter-rouge">SPBM</code> policy name. When a <code class="highlighter-rouge">PVC</code> is created, the vSphere Cloud Provider checks if the user specified datastore satisfies the <code class="highlighter-rouge">gold</code> storage policy requirements. If it does, the vSphere Cloud Provider will provision the <code class="highlighter-rouge">PersistentVolume</code> on the user specified datastore. If not, it will create an error telling the user that the specified datastore is not compatible with <code class="highlighter-rouge">gold</code> storage policy requirements.</p>

<div class="language-yaml highlighter-rouge"><pre class="highlight"><code><span class="s">kind</span><span class="pi">:</span> <span class="s">StorageClass</span>
<span class="s">apiVersion</span><span class="pi">:</span> <span class="s">storage.k8s.io/v1</span>
<span class="s">metadata</span><span class="pi">:</span>
  <span class="s">name</span><span class="pi">:</span> <span class="s">fast</span>
<span class="s">provisioner</span><span class="pi">:</span> <span class="s">kubernetes.io/vsphere-volume</span>
<span class="s">parameters</span><span class="pi">:</span>
    <span class="s">diskformat</span><span class="pi">:</span> <span class="s">zeroedthick</span>
    <span class="s">storagePolicyName</span><span class="pi">:</span> <span class="s">gold</span>
    <span class="s">datastore</span><span class="pi">:</span> <span class="s">Datastore-123</span>
</code></pre>
</div>

<h3 id="vsan">vSAN</h3>

<p>The Kubernetes user will have the ability to specify custom vSAN Storage Capabilities during dynamic volume provisioning. K8s admins can now define storage requirements, such as performance and availability, in the form of storage capabilities during dynamic volume provisioning. The storage capability requirements are converted into a vSAN policy which is then pushed down to the virtual disk layer when a <code class="highlighter-rouge">PersistentVolume</code> (virtual disk) is created. The virtual disk is distributed across the vSAN datastore to meet the policy requirements.</p>

<p>The official <a href="https://www.youtube.com/watch?v=e0wkMPDvKPQ">vSAN policy documentation</a> describes in detail about each of the individual storage capabilities that are supported by vSAN. The user can specify these storage capabilities as part of <code class="highlighter-rouge">StorageClass</code> definition based on his application needs.</p>

<p>For vSAN policies, a few additional parameters can be specified in the <code class="highlighter-rouge">StorageClass</code> if desired or you can use a pre-existing policy by simply specifying <code class="highlighter-rouge">storagePolicyName</code> as above:</p>

<ul>
  <li><code class="highlighter-rouge">cacheReservation:</code> Flash capacity reserved as read cache for the container object. Specified as a percentage of the logical size of the virtual machine disk (vmdk) object. Reserved flash capacity cannot be used by other objects. Unreserved flash is shared fairly among all objects. Use this option only to address specific performance issues.</li>
  <li><code class="highlighter-rouge">diskStripes:</code> The minimum number of capacity devices across which each replica of a object is striped. A value higher than 1 might result in better performance, but also results in higher use of system resources. Default value is 1. Maximum value is 12.</li>
  <li><code class="highlighter-rouge">forceProvisioning:</code> If the option is set to Yes, the object is provisioned even if the Number of failures to tolerate, Number of disk stripes per object, and Flash read cache reservation policies specified in the storage policy cannot be satisfied by the datastore</li>
  <li><code class="highlighter-rouge">hostFailuresToTolerate:</code> Defines the number of host and device failures that a virtual machine object can tolerate. For n failures tolerated, each piece of data written is stored in n+1 places, including parity copies if using RAID 5 or RAID 6.</li>
  <li><code class="highlighter-rouge">iopsLimit:</code> Defines the IOPS limit for an object, such as a VMDK. IOPS is calculated as the number of I/O operations, using a weighted size. If the system uses the default base size of 32 KB, a 64-KB I/O represents two I/O operations</li>
  <li><code class="highlighter-rouge">objectSpaceReservation:</code> Percentage of the logical size of the virtual machine disk (vmdk) object that must be reserved, or thick provisioned when deploying virtual machines. Default value is 0%. Maximum value is 100%.</li>
</ul>

<h4 id="vsan-storageclass">vSAN StorageClass</h4>

<p>In this example <code class="highlighter-rouge">PersistentVolumes</code> will be created via the <code class="highlighter-rouge">StorageClass</code> using the SPBM policy: <code class="highlighter-rouge">vSAN Default Storage Policy</code> which is already created within vCenter:</p>

<div class="language-yaml highlighter-rouge"><pre class="highlight"><code><span class="s">$ cat vsphere-volume-sc-policyname.yaml</span>

<span class="s">kind</span><span class="pi">:</span> <span class="s">StorageClass</span>
<span class="s">apiVersion</span><span class="pi">:</span> <span class="s">storage.k8s.io/v1</span>
<span class="s">metadata</span><span class="pi">:</span>
  <span class="s">name</span><span class="pi">:</span> <span class="s">fast</span>
<span class="s">provisioner</span><span class="pi">:</span> <span class="s">kubernetes.io/vsphere-volume</span>
<span class="s">parameters</span><span class="pi">:</span>
    <span class="s">storagePolicyName</span><span class="pi">:</span> <span class="s2">"</span><span class="s">vSAN</span><span class="nv"> </span><span class="s">Default</span><span class="nv"> </span><span class="s">Storage</span><span class="nv"> </span><span class="s">Policy"</span>
    <span class="s">datastore</span><span class="pi">:</span> <span class="s">vsanDatastore</span>
</code></pre>
</div>

<p>Here, <code class="highlighter-rouge">PersistentVolumes</code> will be created with the vSAN capabilities - <code class="highlighter-rouge">hostFailuresToTolerate</code> set to <code class="highlighter-rouge">2</code> and <code class="highlighter-rouge">cachereservation</code> is <code class="highlighter-rouge">20%</code> - even if no <code class="highlighter-rouge">SPBM</code> policy exists within vCenter.</p>

<div class="language-yaml highlighter-rouge"><pre class="highlight"><code><span class="s">$ cat vsphere-volume-sc-vsancapabilities.yaml</span>

<span class="s">kind</span><span class="pi">:</span> <span class="s">StorageClass</span>
<span class="s">apiVersion</span><span class="pi">:</span> <span class="s">storage.k8s.io/v1</span>
<span class="s">metadata</span><span class="pi">:</span>
  <span class="s">name</span><span class="pi">:</span> <span class="s">fast</span>
<span class="s">provisioner</span><span class="pi">:</span> <span class="s">kubernetes.io/vsphere-volume</span>
<span class="s">parameters</span><span class="pi">:</span>
    <span class="s">hostFailuresToTolerate</span><span class="pi">:</span> <span class="s2">"</span><span class="s">2"</span>
    <span class="s">cachereservation</span><span class="pi">:</span> <span class="s2">"</span><span class="s">20"</span>
</code></pre>
</div>

<p>The K8s user can also specify the datastore in the <code class="highlighter-rouge">StorageClass</code> as shown in the below example. The volume will be created on the datastore specified in the <code class="highlighter-rouge">StorageClass</code>. This field is optional, if not specified as shown in the above example, the volume will be created on the datastore specified in the <code class="highlighter-rouge">vsphere.conf</code> config file used to <a href="/vsphere-storage-for-kubernetes/documentation/existing.html">initialize the vSphere Cloud Provider</a>.</p>

<div class="language-yaml highlighter-rouge"><pre class="highlight"><code><span class="s">$ cat vsphere-volume-sc-vsancapabilities.yaml</span>

<span class="s">kind</span><span class="pi">:</span> <span class="s">StorageClass</span>
<span class="s">apiVersion</span><span class="pi">:</span> <span class="s">storage.k8s.io/v1</span>
<span class="s">metadata</span><span class="pi">:</span>
  <span class="s">name</span><span class="pi">:</span> <span class="s">fast</span>
<span class="s">provisioner</span><span class="pi">:</span> <span class="s">kubernetes.io/vsphere-volume</span>
<span class="s">parameters</span><span class="pi">:</span>
    <span class="s">datastore</span><span class="pi">:</span> <span class="s">vsanDatastore</span>
    <span class="s">hostFailuresToTolerate</span><span class="pi">:</span> <span class="s2">"</span><span class="s">2"</span>
    <span class="s">cachereservation</span><span class="pi">:</span> <span class="s2">"</span><span class="s">20"</span>
</code></pre>
</div>

<p><em>Note: If the storage policy is not set during dynamic provisioning on a vSAN datastore, default vSAN SPBM policy is applied to the volume.</em></p>

<h2 id="create-a-storageclass">Create a StorageClass</h2>

<h3 id="define-the-storageclass">Define the StorageClass</h3>

<div class="language-yaml highlighter-rouge"><pre class="highlight"><code><span class="s">$ cat vsphere-volume-sc-vsancapabilities.yaml</span>

<span class="s">kind</span><span class="pi">:</span> <span class="s">StorageClass</span>
<span class="s">apiVersion</span><span class="pi">:</span> <span class="s">storage.k8s.io/v1</span>
<span class="s">metadata</span><span class="pi">:</span>
  <span class="s">name</span><span class="pi">:</span> <span class="s">fast</span>
<span class="s">provisioner</span><span class="pi">:</span> <span class="s">kubernetes.io/vsphere-volume</span>
<span class="s">parameters</span><span class="pi">:</span>
    <span class="s">datastore</span><span class="pi">:</span> <span class="s">vsanDatastore</span>
    <span class="s">hostFailuresToTolerate</span><span class="pi">:</span> <span class="s2">"</span><span class="s">2"</span>
    <span class="s">cachereservation</span><span class="pi">:</span> <span class="s2">"</span><span class="s">20"</span>
</code></pre>
</div>

<h3 id="import-the-storageclass">Import the StorageClass</h3>

<p>Import the <code class="highlighter-rouge">StorageClass</code> definition into Kubernetes using <code class="highlighter-rouge">kubectl</code>:</p>

<div class="language-sh highlighter-rouge"><pre class="highlight"><code>kubectl create -f vsphere-volume-sc-vsancapabilities.yaml
</code></pre>
</div>

<h3 id="verify-the-storageclass-is-created">Verify the StorageClass is created</h3>

<p>Make sure that the <code class="highlighter-rouge">StorageClass</code> we just created was received correctly and has the correct <code class="highlighter-rouge">parameters</code> set:</p>

<div class="language-sh highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>kubectl describe storageclass fast
Name:		fast
Annotations:	&lt;none&gt;
Provisioner:	kubernetes.io/vsphere-volume
Parameters:	<span class="nv">hostFailuresToTolerate</span><span class="o">=</span><span class="s2">"2"</span>, <span class="nv">cachereservation</span><span class="o">=</span><span class="s2">"20"</span>
No events.
</code></pre>
</div>

<h2 id="create-a-persistentvolumeclaim">Create a PersistentVolumeClaim</h2>

<h3 id="define-the-persistentvolumeclaim">Define the PersistentVolumeClaim</h3>

<p>See below, we are creating a <code class="highlighter-rouge">PVC</code> called <code class="highlighter-rouge">pvcsc-vsan</code> and etting the <code class="highlighter-rouge">volume.beta.kubernetes.io/storage-class</code> key to <code class="highlighter-rouge">fast</code> so it will use the <code class="highlighter-rouge">StorageClass</code> we just created and we are requesting a <code class="highlighter-rouge">2Gi</code> (2GB) <code class="highlighter-rouge">PersistentVolume</code>.</p>

<div class="language-yaml highlighter-rouge"><pre class="highlight"><code><span class="s">kind</span><span class="pi">:</span> <span class="s">PersistentVolumeClaim</span>
<span class="s">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="s">metadata</span><span class="pi">:</span>
  <span class="s">name</span><span class="pi">:</span> <span class="s">pvcsc-vsan</span>
  <span class="s">annotations</span><span class="pi">:</span>
    <span class="s">volume.beta.kubernetes.io/storage-class</span><span class="pi">:</span> <span class="s">fast</span>
<span class="s">spec</span><span class="pi">:</span>
  <span class="s">accessModes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">ReadWriteOnce</span>
  <span class="s">resources</span><span class="pi">:</span>
    <span class="s">requests</span><span class="pi">:</span>
      <span class="s">storage</span><span class="pi">:</span> <span class="s">2Gi</span>
</code></pre>
</div>

<h3 id="import-the-persistentvolumeclaim">Import the PersistentVolumeClaim</h3>

<p>Import the <code class="highlighter-rouge">PVC</code> definition from above into Kubernetes using <code class="highlighter-rouge">kubectl</code>:</p>

<div class="language-sh highlighter-rouge"><pre class="highlight"><code>kubectl create -f vsphere-volume-pvcsc.yaml
</code></pre>
</div>

<h3 id="verify-the-persistentvolumeclaim-was-created">Verify the PersistentVolumeClaim was created</h3>

<p>Check to see if the <code class="highlighter-rouge">PVC</code> we just imported was created and has a <code class="highlighter-rouge">PersistentVolume</code> attached to it. The <code class="highlighter-rouge">Status</code> section below should show <code class="highlighter-rouge">Bound</code> if it worked and the <code class="highlighter-rouge">Volume</code> field should be populated. A <code class="highlighter-rouge">PersistentVolume</code> is automatically created and is bound to this <code class="highlighter-rouge">PVC</code>.</p>

<div class="language-sh highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>kubectl describe pvc pvcsc-vsan
Name:		pvcsc-vsan
Namespace:	default
Status:		Bound
Volume:		pvc-80f7b5c1-94b6-11e6-a24f-005056a79d2d
Labels:		&lt;none&gt;
Capacity:	2Gi
Access Modes:	RWO
No events.
</code></pre>
</div>

<h3 id="verify-a-persistentvolume-was-created">Verify a PersistentVolume was created</h3>

<p>Next, let’s check if a <code class="highlighter-rouge">PV</code> was successfully created for the <code class="highlighter-rouge">PVC</code> we defined above. If it has worked you should have a <code class="highlighter-rouge">PV</code> show up in the output and you should see that the <code class="highlighter-rouge">VolumePath</code> key is populated, as is the case below and the <code class="highlighter-rouge">Status</code> should say <code class="highlighter-rouge">Bound</code>. You can also see the <code class="highlighter-rouge">Claim</code> is set to the above <code class="highlighter-rouge">PVC</code> name <code class="highlighter-rouge">pvcsc-vsan</code>.</p>

<div class="language-sh highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>kubectl describe pv
Name:		pvc-80f7b5c1-94b6-11e6-a24f-005056a79d2d
Labels:		&lt;none&gt;
Status:		Bound
Claim:		default/pvcsc-vsan
Reclaim Policy:	Delete
Access Modes:	RWO
Capacity:	2Gi
Message:
Source:
    Type:	vSphereVolume <span class="o">(</span>a Persistent Disk resource <span class="k">in </span>vSphere<span class="o">)</span>
    VolumePath:	<span class="o">[</span>VSANDatastore] kubevols/kubernetes-dynamic-pvc-80f7b5c1-94b6-11e6-a24f-005056a79d2d.vmdk
    FSType:	ext4
No events.
</code></pre>
</div>

<p><em>VMDKs are created inside a folder named <code class="highlighter-rouge">kubevols</code> in the datastore which is mentioned in the <code class="highlighter-rouge">vsphere.conf</code> vSphere Cloud Provider configuration file. The vSphere Cloud Provider config file is created <a href="/vsphere-storage-for-kubernetes/documentation/existing.html">during setup</a> of Kubernetes cluster on vSphere.</em></p>

<h2 id="define-a-pod-using-the-pvc">Define a Pod using the PVC</h2>

<p>Below is a <code class="highlighter-rouge">Pod</code> config that will use the “<code class="highlighter-rouge">pvcsc-vsan</code>” <code class="highlighter-rouge">PVC</code> that was created above, and thereby the <code class="highlighter-rouge">PV</code> associated with it.</p>

<div class="language-sh highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>cat vsphere-volume-pvcscpod.yaml

apiVersion: v1
kind: Pod
metadata:
  name: pvpod
spec:
  containers:
  - name: <span class="nb">test</span>-container
    image: gcr.io/google_containers/test-webserver
    volumeMounts:
    - name: <span class="nb">test</span>-volume
      mountPath: /test
  volumes:
  - name: <span class="nb">test</span>-volume
    persistentVolumeClaim:
      claimName: pvcsc-vsan
</code></pre>
</div>

<h3 id="create-the-pod">Create the Pod</h3>

<p>Import the <code class="highlighter-rouge">Pod</code> definition using <code class="highlighter-rouge">kubectl</code>:</p>

<div class="language-sh highlighter-rouge"><pre class="highlight"><code>kubectl create -f vsphere-volume-pvcscpod.yaml
</code></pre>
</div>

<h3 id="verify-the-pod-is-created">Verify the Pod is created</h3>

<div class="language-sh highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>kubectl get pod pvpod
NAME      READY     STATUS    RESTARTS   AGE
pvpod       1/1     Running   0          48m
</code></pre>
</div>

<p>You are now successfully creating <code class="highlighter-rouge">PersistentVolumes</code> on demand with <code class="highlighter-rouge">StorageClasses</code> on vSphere.</p>

  

    <div class="tags">
        
    </div>

    

</div>

<footer>
    <div class="row">
        <div class="col-lg-12 footer">
            <div style="float:left;"><img style="max-width:150px;" src="images/company_logo.png" alt="Company logo"/></div>
            <div style="float:right;"></div>&copy;2019 VMWare. All rights reserved.<br />
             Site last generated:
            May 30, 2019</div>
        </div>
    </div>
</footer>


    </div>
    <!-- /.row -->
</div>
<!-- /.container -->
    </div>

</body>

</html>